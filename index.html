<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ACE ENGLISH 학원</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white p-4 max-w-lg mx-auto space-y-6">

  <!-- NAV -->
  <nav class="flex gap-4 border-b border-slate-800 pb-2">
    <button onclick="go('home')" class="hover:text-indigo-400">홈</button>
    <button onclick="go('ann')"  class="hover:text-indigo-400">공지</button>
    <button onclick="go('sched')" class="hover:text-indigo-400">시간표</button>
    <button onclick="go('mat')"  class="hover:text-indigo-400">자료실</button>
    <button onclick="go('ai')" class="hover:text-indigo-400">AI 첨삭</button>
    <button onclick="go('mock')" class="hover:text-indigo-400">모의고사</button>
    <button onclick="go('review')" class="hover:text-indigo-400">오답</button>
  </nav>

  <body>
  <div id="app">

    <!-- ✅ 여기다가 헤더 넣으시면 돼요 -->
    <header class="sticky top-0 z-30 border-b border-slate-800 bg-[#0b1220]/95 backdrop-blur">
      <div class="px-4 py-3 flex items-center justify-between">
        <h1 id="brandTitle" class="text-[15px] font-semibold">ACE ENGLISH</h1>
        <button id="logoutBtn"
          class="hidden text-xs px-3 py-1 rounded-full bg-slate-900 border border-slate-700 hover:bg-slate-800">
          로그아웃
        </button>
      </div>
    </header>



  <!-- VIEW -->
  <main id="view"></main>
  <!-- LOGIN -->
<template id="loginTmpl">
  <section class="mt-6 space-y-5">
    <div class="rounded-2xl bg-gradient-to-br from-indigo-600 to-blue-500 p-4 shadow-lg">
      <p class="text-xs opacity-90">수능 영어 전문 — 즉시 채점 & 해설</p>
      <h2 class="text-xl font-bold tracking-tight">ACE ENGLISH</h2>
    </div>
    <div class="card">
      <h3 class="font-semibold">학생 전용 입장</h3>
      <form id="loginForm" class="mt-3 space-y-3">
        <input id="classCode" placeholder="Class Code (예: 2749)" inputmode="numeric"
               class="w-full rounded-xl bg-slate-900 border border-slate-700 px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500"/>
        <button class="w-full rounded-xl bg-indigo-600 hover:bg-indigo-500 px-4 py-3 font-medium">입장하기</button>
        <p class="text-[11px] text-slate-400">홈 화면에 추가(PWA) 가능</p>
      </form>
    </div>
  </section>
</template>

  <!-- HOME -->
<template id="homeTmpl">
  <section class="space-y-4">

    <!-- 오늘 날짜/시간 + 다음 수업 카운트다운 -->
    <div class="card overflow-hidden p-0">
      <div class="bg-gradient-to-r from-indigo-600/30 via-purple-600/20 to-sky-500/20 p-4">
        <p class="text-xs text-slate-300">오늘</p>
        <div class="flex items-end justify-between gap-4">
          <div>
            <h2 id="clockDate" class="text-lg font-bold tracking-tight">—</h2>
            <p id="clockNow" class="text-4xl font-extrabold leading-none mt-1 select-none tabular-nums">--:--:--</p>
          </div>
          <div class="text-right">
            <span class="inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-slate-900/60 border border-slate-700/60">
              <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
              Live
            </span>
            <p class="text-xs text-slate-300 mt-2">다음 수업</p>
            <p id="nextClassLine" class="font-semibold">—</p>
            <p id="classCountdown" class="text-sm text-slate-300 tabular-nums">--:--:--</p>
          </div>
        </div>
      </div>
      <div class="p-4 grid grid-cols-3 gap-2">
        <button onclick="go('mock')" class="w-full text-sm py-2 rounded-lg bg-slate-900/80 border border-slate-700/60 hover:bg-slate-800">모의고사</button>
        <button onclick="go('ai')" class="w-full text-sm py-2 rounded-lg bg-slate-900/80 border border-slate-700/60 hover:bg-slate-800">AI 첨삭</button>
        <button onclick="go('review')" class="w-full text-sm py-2 rounded-lg bg-slate-900/80 border border-slate-700/60 hover:bg-slate-800">오답</button>
      </div>
    </div>

    <!-- 출석 스트릭 -->
    <div class="card">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">출석 스트릭</h3>
        <button id="attendTodayBtn" class="text-xs px-3 py-1 rounded-full bg-emerald-700/30 border border-emerald-600/50 hover:bg-emerald-700/40">
          오늘 출석
        </button>
      </div>
      <p id="streakText" class="text-sm text-slate-300 mt-2">연속 0일</p>
      <p id="lastAttend" class="text-xs text-slate-400 mt-1">마지막 체크: -</p>
    </div>

    <!-- 숙제 체크리스트 -->
    <div class="card">
      <div class="flex items-center justify-between gap-2">
        <h3 class="font-semibold">오늘 숙제</h3>
        <div class="flex gap-2">
          <input id="hwInput" class="rounded-lg bg-slate-900 border border-slate-700 px-3 py-1.5 text-sm" placeholder="할 일 추가" />
          <button id="hwAddBtn" class="text-xs px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-500">추가</button>
        </div>
      </div>
      <ul id="hwList" class="mt-3 space-y-2"></ul>
    </div>

    <!-- 공부 타이머 -->
    <div class="card">
      <h3 class="font-semibold">공부 타이머</h3>
      <p id="pomodoroLabel" class="text-sm text-slate-300 mt-1">작업 25:00</p>
      <div class="mt-2 flex items-center gap-2">
        <button id="pomodoroStart" class="px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-sm">시작</button>
        <button id="pomodoroStop"  class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm">일시정지</button>
        <button id="pomodoroReset" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-sm">리셋</button>
      </div>
    </div>

    <!-- 최근 AI 피드백 -->
    <div class="card">
      <div class="flex items-center justify-between">
        <h3 class="font-semibold">최근 AI 피드백</h3>
        <button id="aiHistoryClear" class="text-xs text-slate-300 hover:text-white">전체 지우기</button>
      </div>
      <ul id="aiHistory" class="mt-2 space-y-2"></ul>
    </div>

  </section>
</template>

  <!-- AI -->
  <template id="aiTmpl">
    <section>
      <h2 class="text-lg font-bold mb-2">AI 첨삭</h2>
      <form id="aiForm" class="space-y-2">
        <textarea id="aiInput" class="w-full h-32 rounded-lg bg-slate-900 border border-slate-700 p-2 text-sm" placeholder="문제/답안을 입력하세요"></textarea>
        <button class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500">제출</button>
      </form>
      <div id="aiResult" class="mt-4 space-y-2"></div>
    </section>
  </template>

  <!-- MOCK -->
  <template id="mockTmpl">
    <section>
      <h2 class="text-lg font-bold mb-2">모의고사</h2>

      <!-- ✅ 새 파일 옵션 추가 -->
      <select id="mockSelect" class="rounded bg-slate-900 border border-slate-700 px-2 py-1 text-sm">
        <option value="/data/mock-01.json">ACE 모의고사 01</option>
        <option value="/data/mock-02.json">ACE 모의고사 02</option>
        <option value="/data/mock-2025-09-k1_part1_1-20_with_key.json">2025년 9월 고1 모의고사 (1~20번)</option>
      </select>
      <button onclick="startMock()" class="ml-2 px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500">모의고사 시작</button>

      <div id="mockArea" class="mt-4 space-y-4"></div>
      <div id="timer" class="mt-2 text-slate-300"></div>

      <button onclick="submitMock()" class="mt-4 px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500">제출하기</button>
    </section>
  </template>

  <!-- REVIEW -->
  <template id="reviewTmpl">
    <section class="space-y-4">
      <div class="card">
        <h3 class="font-semibold mb-2">오답 모아보기</h3>
        <div class="flex flex-wrap gap-2">
          <button class="px-3 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm filter-btn" data-src="all">전체</button>
          <button class="px-3 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm filter-btn" data-src="mock">모의고사</button>
          <button class="px-3 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm filter-btn" data-src="quiz">스피드퀴즈</button>
          <button class="px-3 py-1 rounded-lg bg-slate-800 border border-slate-700 text-sm filter-btn" data-src="homework">숙제</button>
        </div>
      </div>

      <div id="wrongList" class="space-y-3"></div>

      <div class="card">
        <button id="aiFeedbackSelected" class="w-full px-3 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500">
          선택한 오답 AI 피드백
        </button>
      </div>

      <div id="reviewResult" class="hidden space-y-3"></div>
    </section>
  </template>

  <!-- 공지 -->
<template id="annTmpl">
  <section id="annList" class="space-y-3"></section>
</template>

<!-- 시간표 -->
<template id="schedTmpl">
  <section class="space-y-3">
    <div class="card">
      <h3 class="font-semibold">주간 시간표</h3>
      <ul id="schedList" class="mt-2 divide-y divide-slate-800"></ul>
    </div>
  </section>
</template>

<!-- 자료실 -->
<template id="matTmpl">
  <section class="space-y-3">
    <div class="card">
      <h3 class="font-semibold">자료실</h3>
      <ul id="matList" class="mt-2 space-y-2"></ul>
    </div>
  </section>
</template>


  <!-- SCRIPT -->
  <script>
 const CONFIG = {
  aiEndpoint: "/api/ai-feedback",
  announcements: [
    { title:'9월 모평 해설 업로드', body:'자료실에서 21~30번 집중 해설 확인' },
    { title:'주간 테스트',        body:'수요일 19:00 단어·문법 스피드 퀴즈' },
  ],
  schedule: [
    { day:'월', time:'19:00–21:00', room:'B-203', note:'Reading' },
    { day:'수', time:'19:00–21:00', room:'B-203', note:'Grammar' },
    { day:'금', time:'19:00–21:30', room:'B-203', note:'모의고사' },
  ],
  materials: [
    { title:'9월 모평 해설 PDF', url:'#' },
    { title:'EBS 변형 세트 03', url:'#' },
    { title:'문법 Sprint Day 4', url:'#' },
  ],
  classCode: '2749',
};

// ===== 로그인 / 로그아웃 제어 =====
const authed = () => localStorage.getItem('isAuthed') === '1';

function showLogin() {
  // 로그인 화면만 보이게
  document.getElementById('logoutBtn').classList.add('hidden');
  render('loginTmpl');
  document.getElementById('brandTitle').textContent = CONFIG.brand;

  // 로그인 시도
  document.getElementById('loginForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const code = document.getElementById('classCode').value.trim();
    if (code === CONFIG.classCode) {
      localStorage.setItem('isAuthed', '1');
      init();
    } else {
      alert('클래스 코드가 올바르지 않습니다.');
    }
  });
}

function showApp() {
  document.getElementById('logoutBtn').classList.remove('hidden');
  go(localStorage.getItem('tab') || 'home');
}

document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('isAuthed');
  init();
});

// 초기 실행
function init() {
  document.title = CONFIG.brand + ' — 수능 영어';
  document.getElementById('brandTitle').textContent = CONFIG.brand;
  if (authed()) showApp();
  else showLogin();
}
document.addEventListener('DOMContentLoaded', init);


// === 수업 카운트다운 유틸 ===
const WEEKMAP = { '일':0,'월':1,'화':2,'수':3,'목':4,'금':5,'토':6 };

function parseTimeRange(range){
  const [startStr,endStr] = range.split(/[–-]/);
  const [sh,sm] = startStr.trim().split(':').map(n=>parseInt(n,10));
  const [eh,em] = endStr.trim().split(':').map(n=>parseInt(n,10));
  return { start:{h:sh,m:sm}, end:{h:eh,m:em} };
}

function getNextClassFromSchedule(schedule){
  const now = new Date();
  let best = null;

  for(const it of schedule){
    const w = WEEKMAP[it.day];
    const {start,end} = parseTimeRange(it.time);
    const d = new Date(now);
    const diffToW = (w - d.getDay() + 7) % 7;
    d.setDate(d.getDate() + diffToW);
    d.setHours(start.h, start.m, 0, 0);

    if (d <= now) d.setDate(d.getDate() + 7);

    if (!best || d < best.start) {
      const endDt = new Date(d);
      endDt.setHours(end.h, end.m, 0, 0);
      best = { day: it.day, time: it.time, room: it.room, start: d, end: endDt };
    }
  }
  return best;
}

function setupClassCountdown(){
  const line = document.getElementById('nextClassLine');
  const box  = document.getElementById('classCountdown');

  function fmt2(n){ return String(n).padStart(2,'0'); }

  function tick(){
    const nxt = getNextClassFromSchedule(CONFIG.schedule);
    if(!nxt){ line.textContent='일정 없음'; box.textContent='--:--:--'; return; }

    line.textContent = `${nxt.day} ${nxt.time} ${nxt.room}`;

    const now = new Date();
    let diff = nxt.start - now;

    if (diff <= 0) {
      if (now < nxt.end){
        box.textContent = '수업 진행중';
      } else {
        box.textContent = '곧 다음 일정 계산중…';
      }
      return;
    }

    const sec   = Math.floor(diff/1000);
    const days  = Math.floor(sec/86400);
    const hrs   = Math.floor((sec%86400)/3600);
    const mins  = Math.floor((sec%3600)/60);
    const secs  = sec%60;

    box.textContent = (days>0)
      ? `${days}일 ${fmt2(hrs)}:${fmt2(mins)}:${fmt2(secs)}`
      : `${fmt2(hrs)}:${fmt2(mins)}:${fmt2(secs)}`;
  }

  tick();
  setInterval(tick, 1000);
}
// ===== 로그인 제어 =====
function authed(){ return localStorage.getItem('isAuthed')==='1'; }

// 로그인 상태 확인
function authed(){ return localStorage.getItem('isAuthed')==='1'; }

// 로그인 화면 보여주기
function showLogin(){
  const t = document.getElementById('loginTmpl');
  document.getElementById('view').innerHTML = t.innerHTML;

  const form = document.getElementById('loginForm');
  form.onsubmit = (e)=>{
    e.preventDefault();
    const code = document.getElementById('classCode').value.trim();
    if(code === (CONFIG.classCode||'')){
      localStorage.setItem('isAuthed','1');
      go('home');
    }else{
      alert('클래스 코드가 올바르지 않습니다.');
    }
  };
}

// 앱 시작 (로그인 여부에 따라 분기)
function initApp(){
  if(authed()) go('home');
  else showLogin();
}

  function go(tab){
    const t = document.getElementById(tab+'Tmpl');
    document.getElementById('view').innerHTML = t.innerHTML;
    if(tab==='home') initHome();
    if(tab==='ai') initAI();
    if(tab==='review') renderReviewTab('all');
    if(tab==='ann'){  // 공지
  const t = document.getElementById('annTmpl');
  document.getElementById('view').innerHTML = t.innerHTML;
  const list = document.getElementById('annList');
  list.innerHTML = (CONFIG.announcements||[]).map(a=>`
    <article class="card">
      <h4 class="font-semibold">${a.title}</h4>
      <p class="text-sm text-slate-300 mt-1">${a.body}</p>
    </article>
  `).join('');
}

if(tab==='sched'){ // 시간표
  const t = document.getElementById('schedTmpl');
  document.getElementById('view').innerHTML = t.innerHTML;
  const ul = document.getElementById('schedList');
  ul.innerHTML = (CONFIG.schedule||[]).map(s=>`
    <li class="flex items-center justify-between py-3">
      <div>
        <p class="font-medium">${s.day} • ${s.time}</p>
        <p class="text-sm text-slate-400">${s.room}${s.note?` · ${s.note}`:''}</p>
      </div>
    </li>
  `).join('');
}

if(tab==='mat'){  // 자료실
  const t = document.getElementById('matTmpl');
  document.getElementById('view').innerHTML = t.innerHTML;
  const ul = document.getElementById('matList');
  ul.innerHTML = (CONFIG.materials||[]).map(m=>`
    <li>
      <a class="block rounded-xl border border-slate-800 bg-slate-900/70 px-4 py-3 text-sm hover:bg-slate-800"
         href="${m.url}" target="_blank">${m.title}</a>
    </li>
  `).join('');
}

    
  }

  /* ===== HOME ===== */
  function initHome(){
    const dateEl = document.getElementById('clockDate');
    const timeEl = document.getElementById('clockNow');
    const nextLine = document.getElementById('nextClassLine');
    const cdEl = document.getElementById('classCountdown');

    const yoilTxt = ['일','월','화','수','목','금','토'];

    // 다음 수업 계산기 (CONFIG.schedule 사용)
    const yoilToIdx = { '일':0,'월':1,'화':2,'수':3,'목':4,'금':5,'토':6 };
    function computeNextClass(now=new Date()){
      // CONFIG.schedule: [{day:'월', time:'19:00–21:00', room:'B-203'}, ...]
      const cand = [];
      for(const s of CONFIG.schedule){
        const [start] = (s.time||'').split(/[–~-]/); // 시작시각
        const [hh,mm] = (start||'00:00').split(':').map(x=>parseInt(x,10)||0);
        for(let w=0; w<7; w++){
          const d = new Date(now);
          const want = yoilToIdx[s.day] ?? 0;
          const add = ( (want - now.getDay() + 7) % 7 ) + (w? w*7 : 0);
          d.setDate(d.getDate() + add);
          d.setHours(hh, mm, 0, 0);
          if(d >= now) cand.push({ when:d, meta:s });
          if(cand.length>0) break;
        }
      }
      cand.sort((a,b)=>a.when-b.when);
      return cand[0] || null;
    }

    function fmt2(n){ return String(n).padStart(2,'0'); }

    function tick(){
      const now = new Date();
      // 날짜/시계
      dateEl.textContent = `${now.getFullYear()}-${fmt2(now.getMonth()+1)}-${fmt2(now.getDate())} (${yoilTxt[now.getDay()]})`;
      timeEl.textContent = `${fmt2(now.getHours())}:${fmt2(now.getMinutes())}:${fmt2(now.getSeconds())}`;

      // 다음 수업
      const nxt = computeNextClass(now);
      if(nxt){
        const s = nxt.meta;
        nextLine.textContent = `${s.day} ${s.time} · ${s.room}`;
        const diff = Math.max(0, Math.floor((nxt.when - now)/1000));
        const hh = Math.floor(diff/3600), mm = Math.floor((diff%3600)/60), ss = diff%60;
        cdEl.textContent = `${fmt2(hh)}:${fmt2(mm)}:${fmt2(ss)}`;
      }else{
        nextLine.textContent = '일정 없음';
        cdEl.textContent = '--:--:--';
      }
    }
    tick();
    setInterval(tick, 1000);

    /* ===== 출석 스트릭 ===== */
    const STREAK_KEY='ace.streak', LAST_KEY='ace.lastAttend';
    const btn=document.getElementById('attendTodayBtn'), sTxt=document.getElementById('streakText'), lTxt=document.getElementById('lastAttend');
    const load=(k,def)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(def));
    let streak=load(STREAK_KEY,0), last=load(LAST_KEY,null);
    const fmtDate=d=>`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
    if(last) lTxt.textContent=`마지막 체크: ${last}`;
    sTxt.textContent=`연속 ${streak}일`;
    btn.onclick=()=>{
      const today=fmtDate(new Date());
      if(last===today) return;
      streak=(last&&(new Date(today)-new Date(last))===86400000)?streak+1:1;
      last=today;
      localStorage.setItem(STREAK_KEY,JSON.stringify(streak));
      localStorage.setItem(LAST_KEY,JSON.stringify(last));
      sTxt.textContent=`연속 ${streak}일`; lTxt.textContent=`마지막 체크: ${last}`;
    };

    /* ===== 숙제 ===== */
    const HW_KEY='ace.homework';
    const hwInput=document.getElementById('hwInput'), hwAdd=document.getElementById('hwAddBtn'), hwList=document.getElementById('hwList');
    let items=load(HW_KEY,[]);
    const renderHW=()=>{
      hwList.innerHTML=items.map((it,i)=>`
        <li class="flex justify-between">
          <label><input type="checkbox" ${it.done?'checked':''} data-i="${i}"> ${it.text}</label>
          <button data-i="${i}" class="text-xs">삭제</button>
        </li>`).join('');
      hwList.querySelectorAll('input').forEach(ch=>ch.onchange=e=>{items[e.target.dataset.i].done=e.target.checked; saveHW();});
      hwList.querySelectorAll('button').forEach(b=>b.onclick=e=>{items.splice(e.target.dataset.i,1); saveHW();});
    };
    const saveHW=()=>{localStorage.setItem(HW_KEY,JSON.stringify(items)); renderHW();};
    hwAdd.onclick=()=>{const t=hwInput.value.trim(); if(!t)return; items.push({text:t,done:false}); hwInput.value=''; saveHW();};
    renderHW();

    /* ===== 포모도로 ===== */
    const POMO_KEY='ace.pomo'; let s=load(POMO_KEY,{mode:'work',left:1500,running:false});
    const label=document.getElementById('pomodoroLabel'), startBtn=document.getElementById('pomodoroStart'), stopBtn=document.getElementById('pomodoroStop'), resetBtn=document.getElementById('pomodoroReset');
    const upd=()=>{label.textContent=`${s.mode==='work'?'작업':'휴식'} ${fmt2(Math.floor(s.left/60))}:${fmt2(s.left%60)}`;};
    const saveP=()=>localStorage.setItem(POMO_KEY,JSON.stringify(s));
    let tmr=null; const oneSec=()=>{if(!s.running)return; s.left--; if(s.left<=0){s.mode=s.mode==='work'?'break':'work'; s.left=s.mode==='work'?1500:300;} saveP(); upd();};
    startBtn.onclick=()=>{s.running=true;saveP(); if(!tmr)tmr=setInterval(oneSec,1000);};
    stopBtn.onclick =()=>{s.running=false;saveP();};
    resetBtn.onclick=()=>{s={mode:'work',left:1500,running:false};saveP();upd();};
    upd(); if(s.running){tmr=setInterval(oneSec,1000);}

    // AI 히스토리 박스 초기화
    renderAIHistory();
    document.getElementById('aiHistoryClear').onclick=()=>{localStorage.removeItem('ace.aiHistory');renderAIHistory();};
  }

  /* ===== AI ===== */
  function initAI(){
    const f=document.getElementById('aiForm'), inp=document.getElementById('aiInput'), out=document.getElementById('aiResult');
    f.onsubmit=async e=>{
      e.preventDefault(); out.textContent="피드백 생성중...";
      try{
        const r = await fetch(CONFIG.aiEndpoint,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ taskType:'short', questionText: inp.value, studentAnswer: inp.value })
        });
        const data = await r.json();
        out.innerHTML = renderFeedbackHTML(data);
        saveAIHistory({
          when:new Date().toLocaleString('ko-KR'),
          taskType:'AI 첨삭',
          score:`${data?.score?.value||0}/${data?.score?.max||0}`,
          title: inp.value.slice(0,30)
        });
      }catch{
        out.textContent = 'AI 피드백 실패';
      }
    };
  }

  /* ===== MOCK ===== */
  async function startMock(){
    const src = document.getElementById('mockSelect')?.value || '/data/mock-01.json';
    const res = await fetch(src);
    const exam = await res.json();

    const area = document.getElementById("mockArea");
    area.innerHTML = exam.items.map(q=>{
      if(q.type==="mcq"){
        return `
          <div class="card">
            <p class="font-medium" data-answer="${q.answerKey||q.answer||''}">${q.no}. ${q.question}</p>
            ${q.passage?`<p class="text-sm text-slate-300 mt-1 whitespace-pre-wrap">${q.passage}</p>`:''}
            <div class="mt-2 space-y-1">
              ${q.options.map(opt=>`
                <label class="block text-sm">
                  <input type="radio" name="q${q.no}" value="${opt}"> ${opt}
                </label>`).join('')}
            </div>
            <button class="mt-2 px-2 py-1 rounded bg-indigo-600 text-xs aiExpBtn">AI 해설</button>
            <div class="text-sm mt-2 aiExpBox text-slate-300"></div>
          </div>`;
      } else {
        return `
          <div class="card">
            <p class="font-medium">${q.no}. ${q.question}</p>
            <textarea id="q${q.no}" class="w-full rounded bg-slate-900 border border-slate-700 p-2 text-sm"></textarea>
          </div>`;
      }
    }).join('');

    area.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.aiExpBtn'); if(!btn) return;
      const card = btn.closest('.card');
      const head = card.querySelector('p.font-medium');
      const ans = head?.dataset?.answer || '';
      const questionText = head?.textContent || '';
      const options = Array.from(card.querySelectorAll('label')).map(l=>l.textContent.trim());
      const chosen = (card.querySelector('input[type="radio"]:checked')||{}).value || '';
      const box = card.querySelector('.aiExpBox'); box.textContent = '해설 생성중…';

      try{
        const r = await fetch(CONFIG.aiEndpoint,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            taskType: 'mcq',
            questionText: [questionText, options.map((o,i)=>String.fromCharCode(65+i)+') '+o).join('\n')].join('\n'),
            answerKey: ans, studentAnswer: chosen
          })
        });
        const data = await r.json();
        box.innerHTML = renderFeedbackHTML(data);
      }catch{ box.textContent = '해설 생성 실패'; }
    });
  }

  function submitMock(){
    const area = document.getElementById("mockArea");
    if(!area.firstChild){ alert("먼저 시작하세요!"); return; }

    const blocks = Array.from(area.querySelectorAll('.card'));
    let total=0, correct=0; const detail=[];
    blocks.forEach(block=>{
      const p = block.querySelector('p.font-medium'); if(!p) return;
      const num = parseInt((p.textContent||'').split('.')[0]);
      const radios = block.querySelectorAll(`input[name="q${num}"]`);
      if(radios.length){
        const sel = block.querySelector(`input[name="q${num}"]:checked`);
        const chosen = sel? sel.value : '';
        const ans = p.dataset.answer || '';
        total++;
        const ok = ans && chosen && (ans.trim()===chosen.trim());
        if(ok) correct++; else {
          recordWrong({
            source: 'mock',
            item: {
              no: num, type: 'mcq',
              questionText: p.textContent,
              options: Array.from(block.querySelectorAll('label')).map(l=>l.textContent.trim()),
              answerKey: ans
            },
            studentAnswer: chosen
          });
        }
        detail.push({ no:num, chosen, ans, ok });
      }
    });

    const timer = document.getElementById('timer');
    const used = timer?.textContent || '';
    const scoreHTML = `
      <div class="card">
        <h3 class="font-semibold">결과</h3>
        <p class="text-sm mt-1">점수: <b>${correct}/${total}</b></p>
        <p class="text-xs text-slate-400">소요 시간: ${used||'-'}</p>
        <div class="text-sm mt-2 space-y-1">
          ${detail.map(d=>`<div>Q${d.no}: ${d.ok?'✅ 정답':'❌ 오답'} (정답: ${d.ans||'-'} / 내답: ${d.chosen||'(무응답)'})</div>`).join('')}
        </div>
      </div>`;
    area.insertAdjacentHTML('afterend', scoreHTML);

    saveAttempt({ when: new Date().toISOString(), score:`${correct}/${total}`, duration: used });
  }

  const ATTEMPT_KEY='ace.mockAttempts';
  function loadAttempts(){ try{return JSON.parse(localStorage.getItem(ATTEMPT_KEY)||'[]')}catch{return[]} }
  function saveAttempt(a){ const arr=loadAttempts(); arr.unshift(a); localStorage.setItem(ATTEMPT_KEY, JSON.stringify(arr.slice(0,20))); }

  /* ===== REVIEW ===== */
  const WRONG_KEY = 'ace.wrongs';
  function loadWrongs(){ try { return JSON.parse(localStorage.getItem(WRONG_KEY) || '[]'); } catch { return []; } }
  function saveWrongs(arr){ localStorage.setItem(WRONG_KEY, JSON.stringify(arr.slice(0,200))); }
  function recordWrong(entry){
    const arr=loadWrongs();
    arr.unshift({ ...entry, id:Date.now()+'_'+Math.random().toString(36).slice(2,6), whenISO:new Date().toISOString() });
    saveWrongs(arr);
  }
  function renderReviewTab(filter='all'){
    const root=document.getElementById('wrongList'), resBox=document.getElementById('reviewResult'); resBox.classList.add('hidden'); resBox.innerHTML='';
    const all=loadWrongs(); const list=(filter==='all'?all:all.filter(x=>x.source===filter));
    if(list.length===0){ root.innerHTML='<div class="card text-sm text-slate-300">오답 없음</div>'; return; }
    root.innerHTML=list.map(w=>`
      <div class="card">
        <label class="flex items-start gap-3">
          <input type="checkbox" class="wrong-check mt-1" value="${w.id}">
          <div>
            <div class="text-xs text-slate-400">${w.source.toUpperCase()} · ${new Date(w.whenISO).toLocaleString('ko-KR')}</div>
            <div class="font-medium mt-1">Q${w.item.no}. ${escapeHTML((w.item.questionText||'').split('\n')[0]).slice(0,80)}</div>
            ${w.item.options? `<div class="text-sm mt-1 whitespace-pre-wrap text-slate-300">${escapeHTML(w.item.options.map((o,i)=>String.fromCharCode(65+i)+') '+o).join('\n'))}</div>`:''}
            <div class="text-sm mt-1 text-slate-300">내 답: ${escapeHTML(w.item.studentAnswer||'(무응답)')}</div>
            ${w.item.answerKey? `<div class="text-sm text-slate-400">정답: ${escapeHTML(w.item.answerKey)}</div>`:''}
          </div>
        </label>
      </div>
    `).join('');

    document.querySelectorAll('.filter-btn').forEach(b=> b.onclick=()=>renderReviewTab(b.dataset.src));
    document.getElementById('aiFeedbackSelected').onclick = async ()=>{
      const sel = new Set(Array.from(document.querySelectorAll('.wrong-check:checked')).map(b=>b.value));
      if(sel.size===0){ alert('오답을 선택하세요.'); return; }
      resBox.classList.remove('hidden'); resBox.innerHTML='';
      for(const w of list){
        if(!sel.has(w.id)) continue;
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `<p class="font-medium mb-1">Q${w.item.no} 피드백</p><p class="text-sm text-slate-300">생성 중…</p>`;
        resBox.appendChild(card);
        try{
          const r = await fetch(CONFIG.aiEndpoint,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              taskType: (w.item.type==='writing'?'writing':(w.item.type==='short'?'short':'mcq')),
              questionText: w.item.questionText,
              answerKey: w.item.answerKey || '',
              studentAnswer: w.item.studentAnswer || ''
            })
          });
          const data = await r.json();
          card.innerHTML = `<p class="font-medium mb-1">Q${w.item.no} 피드백</p>` + renderFeedbackHTML(data);
        }catch{
          card.innerHTML = `<p class="font-medium mb-1">Q${w.item.no} 피드백</p><p class="text-sm text-red-300">AI 피드백 실패</p>`;
        }
      }
    };
  }

  /* ===== 공통 유틸 ===== */
  function saveAIHistory(entry){
    const key='ace.aiHistory'; const arr=JSON.parse(localStorage.getItem(key)||'[]'); arr.unshift(entry); localStorage.setItem(key,JSON.stringify(arr.slice(0,5)));
  }
  function renderAIHistory(){
    const ul=document.getElementById('aiHistory'); if(!ul)return;
    const arr=JSON.parse(localStorage.getItem('ace.aiHistory')||'[]');
    if(arr.length===0){ ul.innerHTML=`<li class="text-sm text-slate-400">기록 없음</li>`; return; }
    ul.innerHTML=arr.map(x=>`<li class="text-sm">
      <div class="flex justify-between"><span>${x.when}</span><span>${x.taskType}</span></div>
      <div>점수: ${x.score}</div>
      <div class="truncate">${x.title}</div>
    </li>`).join('');
  }
  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function renderFeedbackHTML(data){
    return `
      <div class="mt-2 p-2 rounded bg-slate-800">
        <div>점수: ${data?.score?.value||0}/${data?.score?.max||0}</div>
        <div class="mt-1">${escapeHTML(data?.verdict||'')}</div>
        <div class="mt-1 whitespace-pre-wrap">${escapeHTML(data?.explanation||'')}</div>
        ${Array.isArray(data?.corrections)&&data.corrections.length? `<ul class="list-disc ml-5 mt-1">${data.corrections.map(c=>`<li>${escapeHTML(c)}</li>`).join('')}</ul>`:''}
        ${Array.isArray(data?.nextSteps)&&data.nextSteps.length? `<p class="mt-1 text-xs text-slate-400">다음 학습: ${data.nextSteps.map(escapeHTML).join(', ')}</p>`:''}
      </div>`;
  }

  initApp();
  </script> 




  <style>
    .card { background: rgba(30,41,59,0.6); border: 1px solid rgba(51,65,85,0.6); padding: 1rem; border-radius: 0.75rem; }
  </style>
</body>
</html>
