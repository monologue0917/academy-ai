# Stage 4-3 테스트 가이드: AI 해설 생성

## 📋 **테스트 시나리오**

### 시나리오 1: 선생님 - AI 해설 생성

#### 전제 조건
- ✅ 시험이 생성되어 있음
- ✅ 문제가 등록되어 있음
- ✅ OpenAI API 키 설정됨

---

#### 단계별 테스트

```
┌─────────────────────────────────────────────────────────────┐
│ Step 1: 선생님 로그인                                       │
└─────────────────────────────────────────────────────────────┘

1. http://localhost:3000/auth/login 접속

2. 선생님 계정으로 로그인
   - Email: teacher@example.com
   - Password: ••••••••

3. Dashboard 진입 확인

┌─────────────────────────────────────────────────────────────┐
│ Step 2: 시험 상세 페이지 접속                               │
└─────────────────────────────────────────────────────────────┘

4. 좌측 사이드바 → "모의고사" 클릭

5. 시험 목록에서 "2024 수능특강 1회 모의고사" 클릭
   → http://localhost:3000/admin/exams/1

6. 시험 상세 페이지 확인
   ✓ 시험 제목
   ✓ 시간/총점 정보
   ✓ 문제 목록

┌─────────────────────────────────────────────────────────────┐
│ Step 3: AI 해설 생성 (첫 번째 문제)                        │
└─────────────────────────────────────────────────────────────┘

7. 1번 문제 카드 확인
   - 문제: "What is the capital of France?"
   - 보기: 5개
   - 정답: 2번 (Paris)

8. "AI 해설 생성" 버튼 클릭

9. 로딩 상태 확인
   ✓ 버튼이 "생성 중..."으로 변경
   ✓ 스피너 표시
   ✓ 버튼 비활성화

10. 해설 생성 완료 (5~10초 소요)
    ✓ 버튼이 "AI 해설 보기"로 변경
    ✓ 해설 영역 표시 (파란색 배경)
    ✓ "✨ AI 해설" 배지

11. 해설 내용 확인
    ```
    ✨ AI 해설 [자동 생성]
    
    ## 한 줄 요약
    프랑스의 수도를 묻는 기본 지리 문제입니다.
    
    ## 문제 해석
    "What is the capital of France?"는 
    "프랑스의 수도는 무엇인가요?"라는 의미입니다.
    - capital: 수도
    - France: 프랑스
    
    ## 정답 해설
    정답은 2번 Paris(파리)입니다.
    Paris는 프랑스의 수도이자 가장 큰 도시로...
    
    ## 오답 분석
    1번 London: 영국(UK)의 수도
    3번 Berlin: 독일(Germany)의 수도
    4번 Madrid: 스페인(Spain)의 수도
    5번 Rome: 이탈리아(Italy)의 수도
    
    ## 학습 포인트
    💡 유럽 주요 국가와 수도를 함께 암기하세요...
    ```

┌─────────────────────────────────────────────────────────────┐
│ Step 4: 해설 재생성 테스트                                  │
└─────────────────────────────────────────────────────────────┘

12. "재생성" 버튼 클릭

13. 확인 사항
    ✓ 새로운 해설 생성 (약간 다를 수 있음)
    ✓ DB 업데이트됨
    ✓ updated_at 시간 갱신

┌─────────────────────────────────────────────────────────────┐
│ Step 5: 다른 문제 해설 생성                                 │
└─────────────────────────────────────────────────────────────┘

14. 2번 문제로 스크롤

15. "AI 해설 생성" 버튼 클릭

16. 해설 생성 완료 확인

┌─────────────────────────────────────────────────────────────┐
│ Step 6: DB 확인 (Supabase)                                  │
└─────────────────────────────────────────────────────────────┘

17. Supabase Dashboard → SQL Editor

18. 쿼리 실행:
    ```sql
    SELECT 
      id,
      content,
      ai_explanation,
      ai_generated_at,
      ai_model
    FROM questions
    WHERE id IN ('q1', 'q2')
    ORDER BY id;
    ```

19. 확인 사항
    ✓ ai_explanation: 해설 텍스트 저장됨
    ✓ ai_generated_at: 타임스탬프 있음
    ✓ ai_model: "gpt-4o-mini" 등

┌─────────────────────────────────────────────────────────────┐
│ Step 7: 캐싱 테스트                                         │
└─────────────────────────────────────────────────────────────┘

20. 페이지 새로고침 (F5)

21. 1번 문제 확인
    ✓ 버튼: "AI 해설 생성" (아직 열려있지 않음)

22. "AI 해설 생성" 버튼 클릭

23. 확인 사항
    ✓ 즉시 표시 (API 호출 없음, 캐싱됨)
    ✓ 로딩 없이 바로 해설 표시
```

---

### 시나리오 2: 학생 - AI 해설 보기

#### 전제 조건
- ✅ 학생이 시험을 제출함
- ✅ 문제에 AI 해설이 생성되어 있음 (선생님이 미리 생성)

---

#### 단계별 테스트

```
┌─────────────────────────────────────────────────────────────┐
│ Step 1: 학생 로그인                                         │
└─────────────────────────────────────────────────────────────┘

1. http://localhost:3000/auth/login 접속

2. 학생 계정으로 로그인
   - Student ID: student-123
   - Password: ••••••••

3. 학생 홈 화면 진입

┌─────────────────────────────────────────────────────────────┐
│ Step 2: 시험 응시 및 제출                                   │
└─────────────────────────────────────────────────────────────┘

4. 하단 탭바 → "모의고사" 탭 클릭

5. "2024 수능특강 1회 모의고사" 카드 클릭

6. "시험 시작하기" 버튼 클릭

7. 문제 풀이
   ✗ 1번: "1번" 선택 (오답, 정답은 2번)
   ✓ 2번: "2번" 선택 (정답)

8. "제출하기" 클릭

9. 확인 다이얼로그 → "제출" 클릭

10. 채점 완료
    → /app/exams/1/result 자동 이동

┌─────────────────────────────────────────────────────────────┐
│ Step 3: 결과 화면 확인                                      │
└─────────────────────────────────────────────────────────────┘

11. 결과 카드 확인
    ✓ 점수: 1점 / 2점 (50%)
    ✓ 정답: 1문제
    ✓ 오답: 1문제

12. 문제별 결과 확인
    - 1번: 🔴 오답 (내 답: 1번, 정답: 2번)
    - 2번: 🟢 정답

┌─────────────────────────────────────────────────────────────┐
│ Step 4: AI 해설 보기 (오답 문제)                            │
└─────────────────────────────────────────────────────────────┘

13. 1번 문제 카드 아래 "✨ AI 해설 보기" 버튼 확인

14. "✨ AI 해설 보기" 버튼 클릭

15. 로딩 상태 확인 (첫 클릭)
    ✓ 버튼: "로딩 중..."
    ✓ 스피너 표시

16. 해설 로드 완료 (3~5초)
    ✓ 해설 영역 펼쳐짐 (흰색 카드, 인디고 테두리)
    ✓ "✨ AI 해설" 헤더
    ✓ "[자동 생성]" 배지

17. 개인화된 해설 확인
    ```
    ✨ AI 해설 [자동 생성]
    
    ## 한 줄 요약
    프랑스의 수도를 묻는 기본 지리 문제입니다.
    
    ## 문제 해석
    "What is the capital of France?"는...
    
    ## 정답 해설
    정답은 2번 Paris입니다.
    
    ## 오답 분석
    학생은 1번 London을 선택했네요.
    
    **왜 틀렸나요?**
    - London은 영국(England/UK)의 수도입니다.
    - France(프랑스)와 England(영국)를 혼동하신 것 같아요.
    
    ## 학습 포인트
    💡 유럽 주요 국가와 수도를 함께 암기하세요:
    - France → Paris ✓
    - England → London
    - Germany → Berlin
    ...
    ```

┌─────────────────────────────────────────────────────────────┐
│ Step 5: 해설 토글 테스트                                    │
└─────────────────────────────────────────────────────────────┘

18. "✨ AI 해설 숨기기" 버튼 클릭

19. 확인 사항
    ✓ 해설 영역 닫힘
    ✓ 버튼: "✨ AI 해설 보기"

20. 다시 "✨ AI 해설 보기" 클릭

21. 확인 사항
    ✓ 즉시 표시 (로딩 없음, 캐싱됨)
    ✓ API 재호출 안 함

┌─────────────────────────────────────────────────────────────┐
│ Step 6: 정답 문제 해설 (공통 해설)                         │
└─────────────────────────────────────────────────────────────┘

22. 2번 문제 (정답) 카드로 스크롤

23. "✨ AI 해설 보기" 버튼 클릭

24. 공통 해설 확인
    ```
    ✨ AI 해설 [자동 생성]
    
    ## 한 줄 요약
    화성(Mars)을 묻는 천문학 문제입니다.
    
    ## 정답 해설
    정답은 2번 Mars입니다.
    Mars는 "Red Planet(빨간 행성)"으로 알려져 있습니다.
    
    ## 오답 분석
    1번 Venus: "Morning Star" 또는 "Evening Star"
    3번 Jupiter: 가장 큰 행성
    4번 Saturn: 고리가 있는 행성
    5번 Mercury: 태양에 가장 가까운 행성
    
    ## 학습 포인트
    ...
    ```

┌─────────────────────────────────────────────────────────────┐
│ Step 7: 피드백 버튼 (선택)                                  │
└─────────────────────────────────────────────────────────────┘

25. 해설 하단 "이 해설이 도움이 되었나요?" 영역 확인

26. "👍 도움됨" 버튼 클릭

27. 피드백 저장 (추후 구현)
    ✓ 토스트 메시지: "피드백 감사합니다!"
    ✓ DB에 피드백 저장
```

---

## 🧪 **에러 케이스 테스트**

### 케이스 1: OpenAI API 키 없음

```
환경 변수 제거:
# .env.local
# OPENAI_API_KEY=

테스트:
1. "AI 해설 생성" 클릭
2. 에러 메시지 확인
   ⚠️ AI 해설 생성에 실패했습니다
   
3. 콘솔 확인
   Error: OPENAI_API_KEY is not defined
```

---

### 케이스 2: 네트워크 오류

```
시뮬레이션:
- 개발자 도구 → Network → Offline

테스트:
1. "AI 해설 생성" 클릭
2. 에러 메시지 확인
   ⚠️ 네트워크 오류가 발생했습니다
```

---

### 케이스 3: 문제가 없는 경우

```
잘못된 questionId로 API 호출:
POST /api/ai/questions/invalid-id/explain

응답:
{
  "error": "문제를 찾을 수 없습니다"
}

Status: 404
```

---

### 케이스 4: OpenAI API 할당량 초과

```
에러:
{
  "error": "AI 해설 생성에 실패했습니다",
  "detail": "insufficient_quota"
}

Status: 500

사용자 메시지:
⚠️ AI 해설 생성에 실패했습니다 (할당량 초과)
```

---

## 📊 **성능 테스트**

### 해설 생성 시간 측정

```
문제 유형별 평균 시간:

1. 단순 객관식 (예: 수도 문제)
   - 토큰: ~800 tokens
   - 시간: 3~5초
   - 비용: $0.001

2. 복잡한 독해 (passage 포함)
   - 토큰: ~1500 tokens
   - 시간: 8~12초
   - 비용: $0.003

3. 문법 문제 (설명 많음)
   - 토큰: ~1200 tokens
   - 시간: 5~8초
   - 비용: $0.002
```

---

### 캐싱 효과 측정

```
시나리오:
- 문제 100개
- 학생 50명

[캐싱 없음]
- API 호출: 5,000번 (50명 × 100문제)
- 시간: ~7시간 (5초 × 5,000)
- 비용: $10

[캐싱 있음]
- API 호출: 100번 (문제당 1번만)
- 시간: ~8분 (5초 × 100)
- 비용: $0.20

절감: 98% ✅
```

---

## 🔍 **DB 검증**

### 해설 저장 확인

```sql
-- 1. AI 해설이 생성된 문제 개수
SELECT 
  COUNT(*) AS total_questions,
  COUNT(ai_explanation) AS with_explanation,
  ROUND(COUNT(ai_explanation)::NUMERIC / COUNT(*) * 100, 2) AS coverage_percent
FROM questions;

-- 예상 결과:
-- total_questions | with_explanation | coverage_percent
-- 100             | 45               | 45.00


-- 2. 최근 생성된 해설 확인
SELECT 
  id,
  LEFT(content, 50) AS question_preview,
  ai_model,
  ai_generated_at,
  LENGTH(ai_explanation) AS explanation_length
FROM questions
WHERE ai_explanation IS NOT NULL
ORDER BY ai_generated_at DESC
LIMIT 5;

-- 예상 결과:
-- id  | question_preview              | ai_model      | ai_generated_at        | length
-- q1  | What is the capital of...     | gpt-4o-mini   | 2024-12-08 10:30:00   | 1234
-- q2  | Which planet is known as...   | gpt-4o-mini   | 2024-12-08 10:31:00   | 1456


-- 3. 통계 뷰 확인
SELECT * FROM ai_usage_stats;

-- 예상 결과:
-- table_name          | total_rows | ai_generated_count | ai_coverage_percent | last_generated_at
-- questions           | 100        | 45                 | 45.00              | 2024-12-08 10:31:00
-- submission_answers  | 5000       | 0                  | 0.00               | NULL
```

---

## ✅ **체크리스트**

### 선생님 테스트

- [ ] 시험 상세 페이지 접속
- [ ] "AI 해설 생성" 버튼 표시
- [ ] 버튼 클릭 → 로딩 스피너
- [ ] 해설 생성 완료 (5~10초)
- [ ] 해설 텍스트 표시 (구조화됨)
- [ ] "재생성" 버튼 작동
- [ ] DB에 저장 확인
- [ ] 페이지 새로고침 → 캐싱 작동

---

### 학생 테스트

- [ ] 시험 응시 및 제출
- [ ] 결과 화면 진입
- [ ] "✨ AI 해설 보기" 버튼 표시
- [ ] 첫 클릭 → 로딩 (3~5초)
- [ ] 개인화된 해설 표시 (오답 시)
- [ ] 공통 해설 표시 (정답 시)
- [ ] "AI 해설 숨기기" 작동
- [ ] 재클릭 → 즉시 표시 (캐싱)

---

### 에러 처리

- [ ] API 키 없음 → 에러 메시지
- [ ] 네트워크 오류 → 에러 메시지
- [ ] 잘못된 questionId → 404
- [ ] 할당량 초과 → 적절한 메시지

---

## 🎯 **성공 기준**

1. ✅ 해설 생성 성공률 > 95%
2. ✅ 평균 생성 시간 < 10초
3. ✅ 캐싱 작동 (중복 호출 없음)
4. ✅ 해설 품질 (구조화, 친절함)
5. ✅ 에러 처리 완벽
6. ✅ 학생/선생님 모두 사용 가능

---

## 📝 **테스트 결과 기록**

### 테스트 실행 정보

```
테스트 날짜: 2024-12-08
테스터: [이름]
환경: Local Development

AI 모델: gpt-4o-mini
평균 응답 시간: [X]초
성공률: [X]%
```

### 발견된 이슈

```
1. [이슈 제목]
   - 현상: [설명]
   - 재현 방법: [단계]
   - 우선순위: High/Medium/Low

2. ...
```

### 개선 제안

```
1. [제안 사항]
   - 이유: [설명]
   - 예상 효과: [효과]
```
